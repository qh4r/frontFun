define(["./colorPicker"],function(t){function e(e,i,n,o,r,h,d){this.db=i,s=!r||s>r?s:r,isNaN(d)||(this.id=d,d>=c&&(c=d+1));var u=document.createElement("div");u.className="note",u.addEventListener("mousedown",function(t){return this.onMouseDown(t)}.bind(this),!1),u.addEventListener("contextmenu",function(t){t.preventDefault(),t.stopPropagation(),this.colorPicker.show(),this.colorPicker.focus()}.bind(this),!1),u.addEventListener("click",function(t){return this.onNoteClick(t)}.bind(this),!1),this.note=u,this.left=n,this.top=o,this.color=h||"#ffeb6e";var a=document.createElement("div");a.className="close-btn",a.addEventListener("click",function(t){return this.close(t)}.bind(this),!1),u.appendChild(a);var l=document.createElement("div");l.className="edit",l.setAttribute("contenteditable",!1),l.addEventListener("keyup",function(t){return this.onKeyUp(t)}.bind(this),!1),u.appendChild(l),this.editField=l;var f=document.createElement("div");return f.className="timestamp",f.addEventListener("mousedown",function(t){return this.onMouseDown(t)}.bind(this),!1),u.appendChild(f),this.lastModified=f,this.colorPicker=new t(["#ff5463","#9cff79","#7fd6ff","#ffeb6e","#b869ff","#ffa450"],function(t){this.updateColor(t)}.bind(this)),this.note.appendChild(this.colorPicker.picker),this.container=e||document.body,this.container.appendChild(this.note),void 0===d&&this.saveAsNew(),this}function i(t){return this!=o?!0:(this.left=t.clientX-this.startX+"px",this.top=t.clientY-this.startY+"px",!1)}function n(){return document.removeEventListener("mousemove",this.mouseMoveHandler,!0),document.removeEventListener("mouseup",this.mouseUpHandler,!0),this.save(),!1}var o=null,s=0,c=0;return e.prototype={get container(){if(!1 in this)throw new Error("no container object");return this._container},set container(t){this._container=t},get db(){if(!1 in this)throw new Error("no db object");return this._db},set db(t){this._db=t},get id(){return"_id"in this||(this._id=0),this._id},set id(t){this._id=t},get text(){return this.editField.textContent},set text(t){this.editField.textContent=t},get timestamp(){return"_timestamp"in this||(this._timestamp=0),this._timestamp},set timestamp(t){if(this._timestamp!==t){this._timestamp=t;var e=new Date(Number(t));this.lastModified.textContent=e}},get left(){return this.note.style.left},set left(t){this.note.style.left=t},get top(){return this.note.style.top},set top(t){this.note.style.top=t},get zIndex(){return this.note.style.zIndex},set zIndex(t){this.note.style.zIndex=t},get color(){return this.note.style.backgroundColor},set color(t){this.note.style.backgroundColor=t},onMouseDown:function(t){o=this,this.startX=t.clientX-this.note.offsetLeft,this.startY=t.clientY-this.note.offsetTop,this.zIndex=++s,"mouseMoveHandler"in this||(this.mouseMoveHandler=function(t){return i.call(this,t)}.bind(this),this.mouseUpHandler=function(t){return n.call(this,t)}.bind(this)),document.addEventListener("mousemove",this.mouseMoveHandler,!0),document.addEventListener("mouseup",this.mouseUpHandler,!0)},onNoteClick:function(){this.editField.setAttribute("contenteditable",!0),this.editField.focus(),getSelection().collapseToEnd()},onKeyUp:function(t){this.dirty=!0,this.saveCounter()},close:function(){this.cancelPendingSave(),this.db.transaction(function(t){t.executeSql("delete from MyNotes where id = ?",[this.id])}.bind(this),function(t){console.log("ERROR --> ",t)},function(t){console.log("usunieto ",t)}),this.container.removeChild(this.note)},cancelPendingSave:function(){"_saveTimer"in this&&(clearTimeout(this._saveTimer),delete this._saveTimer)},saveCounter:function(){this.cancelPendingSave(),this._saveTimer=setTimeout(function(){this.save()}.bind(this),1e3)},save:function(){this.cancelPendingSave(),"dirty"in this&&(this.timestamp=(new Date).getTime(),delete this.dirty),this.db.transaction(function(t){t.executeSql("Update MyNotes set note = ?, timestamp = ?, left = ?, top = ?, zindex = ?, color = ? where id = ?",[this.text,this.timestamp,this.left,this.top,this.zIndex,this.color,this.id])}.bind(this),function(t){console.log("ERROR --> ",t)},function(t){console.log("zapisano ",t)})},updateColor:function(t){this.color=t,this.saveCounter()},saveAsNew:function(){this.timestamp=(new Date).getTime(),this.db.transaction(function(t){t.executeSql("insert into MyNotes (id, note, timestamp, left, top, zindex, color) values(?, ?, ?, ?, ?, ?, ?)",[c,this.text,this.timestamp,this.left,this.top,this.zIndex,this.color])}.bind(this),function(t){return t?console.log("zapisano nowa ",t):void 0},function(){c++})}},e});