define(function(){function t(t,e,n,i,c,d,r){this.db=e,o=!c||o>c?o:c,isNaN(r)||(this.id=r,r>=s&&(s=r+1));var h=document.createElement("div");h.className="note",h.addEventListener("mousedown",function(t){return this.onMouseDown(t)}.bind(this),!1),h.addEventListener("contextmenu",function(t){t.preventDefault(),t.stopPropagation()}.bind(this),!1),h.addEventListener("click",function(t){return this.onNoteClick(t)}.bind(this),!1),this.note=h,this.left=n,this.top=i,this.color=d||"#ffeb6e";var u=document.createElement("div");u.className="close-btn",u.addEventListener("click",function(t){return this.close(t)}.bind(this),!1),h.appendChild(u);var a=document.createElement("div");a.className="edit",a.setAttribute("contenteditable",!1),a.addEventListener("keyup",function(t){return this.onKeyUp(t)}.bind(this),!1),a.addEventListener("blur",function(){console.log("blurred")}),h.appendChild(a),this.editField=a;var l=document.createElement("div");return l.className="timestamp",l.addEventListener("mousedown",function(t){return this.onMouseDown(t)}.bind(this),!1),h.appendChild(l),this.lastModified=l,this.container=t||document.body,this.container.appendChild(this.note),void 0===r&&(console.log("ideeeee",r),this.saveAsNew()),this}function e(t){return this!=i?!0:(this.left=t.clientX-this.startX+"px",this.top=t.clientY-this.startY+"px",!1)}function n(){return document.removeEventListener("mousemove",this.mouseMoveHandler,!0),document.removeEventListener("mouseup",this.mouseUpHandler,!0),this.save(),!1}var i=null,o=0,s=0;return t.prototype={get container(){if(!1 in this)throw new Error("no container object");return this._container},set container(t){this._container=t},get db(){if(!1 in this)throw new Error("no db object");return this._db},set db(t){this._db=t},get id(){return"_id"in this||(this._id=0),this._id},set id(t){this._id=t},get text(){return this.editField.textContent},set text(t){this.editField.textContent=t},get timestamp(){return"_timestamp"in this||(this._timestamp=0),this._timestamp},set timestamp(t){if(this._timestamp!==t){this._timestamp=t;var e=new Date(Number(t));this.lastModified.textContent=e}},get left(){return this.note.style.left},set left(t){this.note.style.left=t},get top(){return this.note.style.top},set top(t){this.note.style.top=t},get zIndex(){return this.note.style.zIndex},set zIndex(t){this.note.style.zIndex=t},get color(){return this.note.style.backgroundColor},set color(t){this.note.style.backgroundColor=t},onMouseDown:function(t){i=this,this.startX=t.clientX-this.note.offsetLeft,this.startY=t.clientY-this.note.offsetTop,this.zIndex=++o,"mouseMoveHandler"in this||(this.mouseMoveHandler=function(t){return e.call(this,t)}.bind(this),this.mouseUpHandler=function(t){return n.call(this,t)}.bind(this)),document.addEventListener("mousemove",this.mouseMoveHandler,!0),document.addEventListener("mouseup",this.mouseUpHandler,!0)},onNoteClick:function(){this.editField.setAttribute("contenteditable",!0),this.editField.focus(),getSelection().collapseToEnd()},onKeyUp:function(t){this.dirty=!0,this.saveCounter()},close:function(){this.cancelPendingSave(),this.db.transaction(function(t){t.executeSql("delete from MyNotes where id = ?",[this.id])}.bind(this),function(t){console.log("ERROR --> ",t)},function(t){console.log("usunieto ",t)}),this.container.removeChild(this.note)},cancelPendingSave:function(){"_saveTimer"in this&&(clearTimeout(this._saveTimer),delete this._saveTimer)},saveCounter:function(){this.cancelPendingSave(),this._saveTimer=setTimeout(function(){this.save()}.bind(this),1e3)},save:function(){this.cancelPendingSave(),"dirty"in this&&(this.timestamp=(new Date).getTime(),delete this.dirty),this.db.transaction(function(t){t.executeSql("Update MyNotes set note = ?, timestamp = ?, left = ?, top = ?, zindex = ? where id = ?",[this.text,this.timestamp,this.left,this.top,this.zIndex,this.id])}.bind(this),function(t){console.log("ERROR --> ",t)},function(t){console.log("zapisano ",t)})},saveAsNew:function(){this.timestamp=(new Date).getTime(),this.db.transaction(function(t){t.executeSql("insert into MyNotes (id, note, timestamp, left, top, zindex) values(?, ?, ?, ?, ?, ?)",[s,this.text,this.timestamp,this.left,this.top,this.zIndex])}.bind(this),function(t){return t?console.log("zapisano nowa ",t):void 0},function(){s++})}},t});